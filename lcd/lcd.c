/*
===============================================================================
 Name        : lcd.c
 Author      : M. Verhoest
 Version     :
 Copyright   : $(copyright)
 Description : main definition
===============================================================================
*/
#include "lcd.h"

unsigned char buffer[512];
unsigned char array_font[] = {
/* sp */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
/* ! */  0x00, 0x00, 0x5F, 0x5F, 0x00, 0x00, 0x00, 0x00,
/* " */  0x00, 0x00, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00,
/* # */  0x14, 0x14, 0x7F, 0x14, 0x7F, 0x14, 0x14, 0x00,
/* $ */  0x00, 0x2E, 0x2A, 0x7F, 0x2A, 0x3A, 0x00, 0x00,
/* % */  0x47, 0x25, 0x17, 0x08, 0x74, 0x52, 0x71, 0x00,
/* & */  0x00, 0x20, 0x56, 0x49, 0x56, 0x20, 0x50, 0x00,
/* ' */  0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,0x00,
/* ( */  0x00, 0x1C, 0x22, 0x41, 0x41, 0x00, 0x00, 0x00,
/* ) */  0x00, 0x00, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00,
/* * */  0x00, 0x2A, 0x1C, 0x3E, 0x1C, 0x2A, 0x00, 0x00,
/* + */  0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00,
/* , */  0x00, 0x00, 0x30, 0x70, 0x00, 0x00, 0x00, 0x00,
/* - */  0x00, 0x00, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00,
/* . */  0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
/* / */  0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00,
/* 0 */  0x00, 0x3E, 0x63, 0x41, 0x63, 0x3E, 0x00, 0x00,
/* 1 */  0x00, 0x04, 0x42, 0x7F, 0x40, 0x00, 0x00, 0x00,
/* 2 */  0x00, 0x72, 0x49, 0x49, 0x49, 0x4f, 0x00, 0x00,
/* 3 */  0x00, 0x22, 0x41, 0x49, 0x49, 0x3C, 0x00, 0x00,
/* 4 */  0x10, 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00,
/* 5 */  0x00, 0x67, 0x45, 0x45, 0x45, 0x79, 0x00, 0x00,
/* 6 */  0x00, 0x3E, 0x51, 0x49, 0x49, 0x32, 0x00, 0x00,
/* 7 */  0x00, 0x01, 0x01, 0x71, 0x0D, 0x07, 0x00, 0x00,
/* 8 */  0x00, 0x36, 0x59, 0x49, 0x49, 0x59, 0x36, 0x00,
/* 9 */  0x00, 0x46, 0x49, 0x49, 0x49, 0x59, 0x36, 0x00,
/* : */  0x00, 0x00, 0x00, 0x36, 0x36, 0x00, 0x00, 0x00,
/* ; */  0x00, 0x00, 0x00, 0x36, 0x76, 0x00, 0x00, 0x00,
/* < */  0x00, 0x00, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00,
/* = */  0x00, 0x00, 0x36, 0x36, 0x36, 0x36, 0x00, 0x00,
/* > */  0x00, 0x00, 0x41, 0x22, 0x14, 0x08, 0x00, 0x00,
/* ? */  0x00, 0x06, 0x01, 0x59, 0x19, 0x09, 0x06, 0x00,
/* @ */  0x00, 0x3E, 0x41, 0x49, 0x55, 0x4E, 0x00, 0x00,
/* A */  0x60, 0x18, 0x16, 0x13, 0x16, 0x18, 0x60, 0x00,
/* B */  0x00, 0x7F, 0x49, 0x49, 0x59, 0x36, 0x00, 0x00,
/* C */  0x1C, 0x22, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00,
/* D */  0x00, 0x7F, 0x41, 0x41, 0x41, 0x22, 0x1C, 0x00,
/* E */  0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00,
/* F */  0x00, 0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00,
/* G */  0x1C, 0x22, 0x41, 0x41, 0x49, 0x2A, 0x78, 0x00,
/* H */  0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00,
/* I */  0x00, 0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00,
/* J */  0x10, 0x21, 0x41, 0x21, 0x1F, 0x01, 0x00, 0x00,
/* K */  0x7F, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00,
/* L */  0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00,
/* M */  0x7F, 0x02, 0x04, 0x08, 0x04, 0x02, 0x7F, 0x00,
/* N */  0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00, 0x00,
/* O */  0x1C, 0x22, 0x41, 0x41, 0x41, 0x22, 0x1C, 0x00,
/* P */  0x00, 0x7F, 0x11, 0x11, 0x0A, 0x04, 0x00, 0x00,
/* Q */  0x1C, 0x22, 0x41, 0x41, 0x51, 0x22, 0x5C, 0x00,
/* R */  0x00, 0x7F, 0x11, 0x11, 0x7A, 0x04, 0x00, 0x00,
/* S */  0x00, 0x26, 0x49, 0x49, 0x49, 0x51, 0x62, 0x00,
/* T */  0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x00, 0x00,
/* U */  0x00, 0x1F, 0x20, 0x40, 0x40, 0x20, 0x1F, 0x00,
/* V */  0x00, 0x07, 0x18, 0x60, 0x18, 0x07, 0x00, 0x00,
/* W */  0x07, 0x78, 0x18, 0x06, 0x18, 0x78, 0x07, 0x00,
/* X */  0x41, 0x22, 0x14, 0x08, 0x14, 0x22, 0x41, 0x00,
/* Y */  0x01, 0x02, 0x04, 0x78, 0x04, 0x02, 0x01, 0x00,
/* Z */  0x00, 0x61, 0x51, 0x49, 0x45, 0x42, 0x41, 0x00,
/* [ */  0x00, 0x00, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00,
/* \ */  0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00,
/* ] */  0x00, 0x00, 0x41, 0x41, 0x7F, 0x00, 0x00, 0x00,
/* ^ */  0x00, 0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00,
/* _ */  0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00,
/* ' */  0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
/* a */  0x00, 0x38, 0x44, 0x44, 0x28, 0x78, 0x00, 0x00,
/* b */  0x00, 0x7F, 0x44, 0x44, 0x28, 0x18, 0x00, 0x00,
/* c */  0x00, 0x38, 0x44, 0x44, 0x28, 0x00, 0x00, 0x00,
/* d */  0x00, 0x38, 0x44, 0x44, 0x44, 0x7F, 0x00, 0x00,
/* e */  0x00, 0x38, 0x54, 0x54, 0x54, 0x18, 0x00, 0x00,
/* f */  0x00, 0x08, 0x7E, 0x09, 0x09, 0x02, 0x00, 0x00,
/* g */  0x00, 0x58, 0x54, 0x54, 0x4C, 0x3C, 0x00, 0x00,
/* h */  0x00, 0x7F, 0x08, 0x04, 0x08, 0x70, 0x00, 0x00,
/* i */  0x00, 0x00, 0x00, 0x7A, 0x00, 0x00, 0x00, 0x00,
/* j */  0x00, 0x60, 0x40, 0x40, 0x3A, 0x00, 0x00, 0x00,
/* k */  0x00, 0x7F, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00,
/* l */  0x00, 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00,
/* m */  0x7C, 0x04, 0x04, 0x78, 0x04, 0x04, 0x78, 0x00,
/* n */  0x00, 0x00, 0x7C, 0x04, 0x04, 0x78, 0x00, 0x00,
/* o */  0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00,
/* p */  0x00, 0x7C, 0x28, 0x24, 0x24, 0x18, 0x00, 0x00,
/* q */  0x00, 0x18, 0x24, 0x28, 0x7C, 0x00, 0x00, 0x00,
/* r */  0x00, 0x78, 0x10, 0x08, 0x04, 0x08, 0x00, 0x00,
/* s */  0x00, 0x58, 0x54, 0x54, 0x54, 0x34, 0x00, 0x00,
/* t */  0x00, 0x08, 0x08, 0x7C, 0x48, 0x08, 0x00, 0x00,
/* u */  0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00, 0x00,
/* v */  0x00, 0x0C, 0x30, 0x40, 0x30, 0x0C, 0x00, 0x00,
/* w */  0x0C, 0x30, 0x40, 0x30, 0x40, 0x30, 0x0C, 0x00,
/* x */  0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00,
/* y */  0x00, 0x04, 0x08, 0x70, 0x08, 0x04, 0x00, 0x00,
/* z */  0x00, 0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00,
/* { */  0x00, 0x08, 0x08, 0x36, 0x41, 0x41, 0x00, 0x00,
/* | */  0x00, 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00,
/* } */  0x00, 0x41, 0x41, 0x36, 0x08, 0x08, 0x00, 0x00,
/* ~ */  0x00, 0x10, 0x08, 0x10, 0x08, 0x10, 0x00, 0x00,
/*del*/  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
/* check */ 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA,
/* stripe*/ 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00
};

// TODO: insert other include files here

// TODO: insert other definitions and declarations here
//MOSI p5 P0.9 v
//nRESET P6 P0.8
//sck P7 v
//A0 P8  P0.6
//nCS P11 P0.18
void lcdInit(void)
{
	//Define output port directions
	LPC_GPIO0->FIODIR1 |= (1<<8);  //nRESET
	LPC_GPIO0->FIODIR0 |= (1<<6); //A0
	//LPC_GPIO0->FIODIR2 |= (1<<2); //nCS
	LPC_GPIO0->FIOSET =  (1<<6) | (1<<8);  //Initialise control lines high

	//lcd init
	SpiInit();

	//timer init
	init_Timer0();
}



void setRegister(uint8_t control,uint8_t reg)
{
	if (control==1)
	{
			//turn on LED2
			LPC_GPIO0->FIOSET |=(1 << reg);
		} else {
			//turn off LED2
			LPC_GPIO0->FIOCLR|= (1 << reg);
		}
}

void setReset(uint8_t control)
{
	setRegister(control,8);
}

void setAZero(uint8_t control)
{
	setRegister(control,6);
}

void setNCS(uint8_t control)
{
	setRegister(control,18);
}

void writeCmd(unsigned char cmd)
{

	///setNCS(0);
	setAZero(0);
	spi_tfr(cmd);
	//setNCS(1);
	setAZero(1);
}


void writeData(unsigned char data)
{
	//setAZero(1);
	//setNCS(0);
	spi_tfr(data);
	//setNCS(1);
}

void lcdReset(void)
{
	//setAZero(0);
	//setNCS(1);
	//display reset
	setReset(0);
	delay_us(50);
	setReset(1);
	delay_ms(5);
	//end reset

	//start init
	writeCmd(0xAE); //display off
	writeCmd(0xA2); //bias voltage

	writeCmd(0xA0);
	writeCmd(0xC8); //column normal

	writeCmd(0x22); //voltage resistor ratio
	writeCmd(0x2F); //power on
	writeCmd(0x40); //start line =0
	writeCmd(0xAF); //display ON

	writeCmd(0x81); //set contrast
	writeCmd(0x17); //set contrast

	writeCmd(0xA6); //display normal


	//clear and update LCD
	memset(buffer,0x00,512); //clear display buffer
	//copy to lcd
	copyToLcd();
	//locate 0 0
	//set_font
	clearLcd();


	placeCursor(0,0);

}

void pixel(int a,int b,int color,uint8_t drawMode)
//set one pixel in the buffer
{
	//check if not out of bounds of screen
	if(a>128 || b>32 || a < 0 || b< 0) return;

	//drawMode 1 normal
	if(drawMode == 1)
	{
		if(color ==0)
		{
			buffer[a+(b/8*128)] &= ~(1<<(b%8)); //erase pixel
		}
		else
		{
			buffer[a+((b/8)*128)] |= (1<<(b%8)); //set pixel
		}

	}
	else //drawMode 0 XOR
	{
		if(color ==1)
		{
			buffer[a+((b/8)*128)] ^= (1<<b%8); //xor pixel
		}
	}
}


void placeCursor(char pagina,char kolom)
{
	//out of bounds errors
	if( pagina > 3)
	{
		pagina =0;
	}
	if(kolom>127)
	{
		kolom = 0;
	}
	writeCmd(0x00+(kolom & 0x0F));
	writeCmd(0x10+(kolom/16));
	writeCmd(0xB0+pagina); //SET pagina adress to zero
	writeCmd(0xE0); //auto increment the lcd
}


void copyToLcd(void)
//copy buffer to lcd
{
	int k=0;

	//write page one 
	writeCmd(0x00); //set the column low nibble to 0
	writeCmd(0x10); //set the column high nibble to 0
	writeCmd(0xB0); //set the page address to 0
	//setAZero(1);

	for(k=0;k<128;k++)
	{
		writeData(buffer[k]);
	}

	//write page two 
	writeCmd(0x00); //set the colum low nibble to 0
	writeCmd(0x10); //set the colum high nibble to 0
	writeCmd(0xB1); //set page adress to one 
	//setAZero(1);
	for ( k = 256; k < 384; k++)
	{
		writeData(buffer[k]);
	}
	
	//write page three
	writeCmd(0x00); //set the colum low nibble to zero 
	writeCmd(0x10); //set the colim high nibble to zero 
	writeCmd(0xB3); //set page adress three 

	//setNCS(0);

	for (k  = 0; k < 512; k++)
	{
		writeData(buffer[k]);
	}
	


}

void dispLine(char c)
{
	int k;
	for(k=0;k<128;k++)
	{
		writeData(c);
	}
}


void clearLcd(void)
{
	int k;
	for(k=0;k<4;k++)
	{
		placeCursor(k,0);
		dispLine(0x00);

		 //TESTING
		//dispLine(0x00); //PRODUCTION
	}

	placeCursor(0,0);
}


void createChar(unsigned char c)
{
	int x,y;
	y = (c-(' '))*8;
	for(x=0;x<8;x++)
	//8 pixels width per char
	{
		spi_tfr(array_font[y]);
		y++;
	}
}

void dispChar(int lijn,int kolom,unsigned char c)
{
	placeCursor(lijn,8*kolom);
	createChar(c);
}

void dispString(int lijn,int kolom,char * str)
{
	placeCursor(lijn,8*kolom);
	while(*str)
		createChar(*str++);
}



